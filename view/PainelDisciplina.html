<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/style_hp.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Document</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
            src="css/img/logo.png"
            alt="Avatar Logo"
            style="width: 40px"
            class="rounded-pill"
          />
        </a>
        <a class="navbar-brand" href="#">Uni-Class</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#collapsibleNavbar"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#" id="btnHome">home</a>
            </li>
            </li>
          </ul>
        </div>
        <div id="divPainel" style="color: white"></div>
      </div>
    </nav>

    <div id="divResposta" style="padding-left: 30px; padding-top: 30px"></div>
    <div style="padding-left: 30px; padding-top: 10px">
      <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAtualizarTurma">
        Atualizar
      </button>      
      <button type="button" class="btn btn-danger" id="btnDeleteDisciplina">
        Excluir
      </button>
    </div>

    <!-- The Modal -->
    <div class="modal fade" id="modalAtualizarTurma">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">

          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Atualizar Disciplina</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <!-- Modal body -->
          <div class="modal-body">
            <div class="input-line-container">
              <span class="name-input">Nome da Turma</span>
              <input type="text" id="txtNomeTurma_atualizar" class="input-line" id="" />
            </div>
            <div class="input-line-container">
              <span class="name-input">Abreviacao</span>
              <input type="text" id="txtAbreviacaoTurma_atualizar" class="input-line" id="" />
            </div>
            <div class="input-line-container">
              <span class="name-input">Ano</span>
              <input type="text" id="txtAnoTurma_atualizar" class="input-line" id="" />
            </div>
          </div>

          <!-- Modal footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-warning" data-bs-dismiss="modal" id="btnUpdateTurma">Atualizar</button>
          </div>

        </div>
      </div>
    </div>


    <div class="container mt-5">
      <div class="row" id="container">
        <div class="col-sm-4">
          <div class="card bg-secondary text-white" style="width: 400px">
            <div class="card-body">
              <h4 class="card-title">Add Disciplina</h4>
              <p class="card-text">
                O processo de adicionar uma disciplina faz com que se possa
                realizar a inserção de turmas e notas a partir desta
              </p>
              <button
                type="button"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#modalDisciplina"
              >
                Criar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container mt-5">
      <div class="row" id="container">
        <h2>Notas x Alunos:</h2>
        <table class="table table-dark table-striped">
          <thead>
            <tr>
              <th>ID Nota</th>
              <th>Nome Turma</th>
              <th>ID Disciplina</th>
              <th>Nome Disciplina</th>
              <th>Aluno Matricula</th>
              <th>Nome Aluno</th>
              <th>Bimestre</th>
              <th>Nota</th>
              <th>Ultima Alteracao</th>
              <th>Tipo Nota</th>
              <th>Fez Lista</th>
              <th>Selecionar</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Os dados da tabela serão inseridos aqui dinamicamente com JavaScript -->
          </tbody>
        </table>
        <div class="btn-group">
          <button type="button" class="btn btn-success" id="btnExportarCsv">Exportar CSV</button>
          <button type="button" class="btn btn-info" id="btnExportargrafico">Gerar Grafico</button>
        </div>
      </div>
    </div>

    <div class="container mt-5">
      <div class="row" id="container">
        <div class="col-sm-4">
          <div class="card bg-secondary text-white" style="width: 400px">
            <div class="card-body">
              <div class="input-line-container">
                <span class="name-input">Aluno Matricula</span>
                <input type="text" id="txtAlunoMatricula_Detalhes" class="input-line" style="border-bottom: 2px solid white; color: white"/>
              </div>
              <div class="input-line-container">
                <span class="name-input">Nome do aluno</span>
                <input type="text" id="txtNomeAluno_Detalhes" class="input-line" style="border-bottom: 2px solid white; color: white"/>
              </div>
              <div class="input-line-container">
                <span class="name-input">Bimestre</span>
                <input type="text" id="txtBimestre_Detalhes" class="input-line" style="border-bottom: 2px solid white; color: white"/>
              </div>
              <button type="button" class="btn btn-primary" id="btnGetAlunoNota">
                Selecionar
              </button>
            </div>
          </div>
        </div>
        <div class="col-sm-8">
          <table class="table table-dark table-striped">
            <thead>
              <tr>
                <th>Matricula Aluno</th>
                <th>Bimestre</th>
                <th>Nota</th>
                <th>Lista</th>
              </tr>
            </thead>
            <tbody id="tableBody_Detalhes_Aluno">
              <!-- Os dados da tabela serão inseridos aqui dinamicamente com JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="container mt-5">
      <div class="row" id="container">
        <canvas id="chartContainer" width="30px" height="30px"></canvas>
      </div>
    </div>
    <!-- MODAL DA DISCIPLINA -->

    <!-- The Modal -->
    <div class="modal fade" id="modalDisciplina">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">Cadastrar uma Disciplina</h4>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <!-- Modal body -->
          <div class="modal-body">
            <div class="input-line-container">
              <span class="name-input">Nome da Disciplina</span>
              <input type="text" id="txtNome_D" class="input-line" id="" />
            </div>

          <!-- Modal footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-success"
              data-bs-dismiss="modal"
              id="btnDisciplina"
            >
              Criar
            </button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="/js/turma.js"></script>
    <script type="text/javascript" src="/js/disciplina.js"></script>
    <script type="text/javascript" src="/js/disciplina_nota.js"></script>
    <script type="text/javascript" src="/js/botoes.js"></script>
    <script type="text/javascript" src="/js/disciplina_delete_update.js"></script>
    <script>
      // Recupera os dados do localStorage
      var dadosTurmaString = localStorage.getItem("dadosTurma");
    
      // Verifica se há dados no localStorage
      if (dadosTurmaString) {
        // Converte a string JSON de volta para um objeto JavaScript
        var dadosTurma = JSON.parse(dadosTurmaString);
    
        // Recupera o nome da turma
        var nomeTurma = dadosTurma.turma.nomeTurma;
    
        // Atualiza o texto dentro da div com o nome da turma
        var divResposta = document.getElementById("divResposta");
        if (divResposta) {
          divResposta.innerHTML = "<h1>" + nomeTurma + "</h1>";
        } else {
          console.error("A div com id 'divResposta' não foi encontrada.");
        }
      } else {
        console.error("Não há dados de turma no localStorage.");
      }
    
      // Função para gerar o card dinamicamente
      function gerarCard(idDisciplina, nomeDisciplina) {
        var divCol = document.createElement("div");
        var divCard = document.createElement("div");
        var divCardBody = document.createElement("div");
        var cardTitle = document.createElement("h4");
        var cardText = document.createElement("p");
        var buttonAceder = document.createElement("button");
    
        divCol.classList.add("col-sm-4");
        divCard.classList.add("card");
        divCard.classList.add("bg-secondary");
        divCard.classList.add("text-white");
        divCard.style.width = "400px";
        divCardBody.classList.add("card-body");
        cardTitle.classList.add("card-title");
        cardTitle.textContent = "Nome da Disciplina: " + nomeDisciplina;
        cardText.classList.add("card-text");
        cardText.textContent = "ID da Disciplina: " + idDisciplina;
        buttonAceder.classList.add("btn", "btn-success");
        buttonAceder.type = "button";
        buttonAceder.textContent = "Acessar";
    
        // Adiciona um evento de clique ao botão
        buttonAceder.addEventListener("click", function () {
          // Chama a função e passa as informações relevantes
          handleClick(nomeDisciplina, idDisciplina);
        });
    
        divCardBody.appendChild(cardTitle);
        divCardBody.appendChild(cardText);
        divCardBody.appendChild(buttonAceder);
    
        divCard.appendChild(divCardBody);
        divCol.appendChild(divCard);
    
        var container = document.getElementById("container");
        container.appendChild(divCol);
      }
    
      // Função para lidar com o clique do botão
      function handleClick(nomeDisciplina, idDisciplina) {
        // Coloque aqui o código para lidar com o clique do botão
        console.log("Nome da Disciplina:", nomeDisciplina);
        console.log("ID da Disciplina:", idDisciplina);
    
        // Cria um objeto para armazenar os valores
        var dadosDisciplina = {
          disciplina: {
            nomeDisciplina: nomeDisciplina,
            idDisciplina: idDisciplina,
          },
        };
    
        // Converte o objeto para uma string JSON e armazena no localStorage
        localStorage.setItem("dadosDisciplina", JSON.stringify(dadosDisciplina));
    
        // Redireciona o usuário para outra página (substitua 'sua_pagina.html' pelo URL desejado)
        window.location.href = "PainelNota.html";
      }
    
      // Código principal
      window.onload = function () {
        // Recupera os dados do localStorage
        var dadosTurmaString = localStorage.getItem("dadosTurma");
        const objetoProfessor = JSON.parse(
          localStorage.getItem("jsonProfessor")
        );
    
        // Verifica se há dados no localStorage
        if (dadosTurmaString != "" && objetoProfessor.registro != "") {
          // Converte a string JSON de volta para um objeto JavaScript
          var dadosTurma = JSON.parse(dadosTurmaString);
    
          // Recupera o nome da turma
          var idTurma = dadosTurma.turma.idTurma;
          var registroProf = objetoProfessor.registro;
        }
    
        const uri = "/disciplina/prof/" + registroProf + "/" + idTurma;
    
        const requisicao_assincrona = fetch(uri, {
          method: "get",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            Authorization: "",
          },
        });
    
        requisicao_assincrona
          .then((response) => {
            return response.json();
          })
          .then((objetoJson) => {
            if (objetoJson.status === true) {
              const dados = objetoJson.dados;
    
              dados.forEach((disciplina) => {
                console.log("ERA PRA APARECER O NOME DA DISCIPLINA DESSE PROF");
                console.log("Nome da Disciplina:", disciplina.nome);
    
                if (disciplina.nome != "") {
                  // Chama a função para gerar o card dinamicamente
                  gerarCard(disciplina.idDisciplina, disciplina.nome);
                }
              });
            } else {
              console.log("deu ruim");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
    
        const uri_aluno_nota = "/turma/notaaluno/" + idTurma;
    
        const requisicao_assincrona_aluno_nota = fetch(uri_aluno_nota, {
          method: "get",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            Authorization: "",
          },
        });
    
        requisicao_assincrona_aluno_nota
          .then((response) => {
            return response.json();
          })
          .then((objetoJson) => {
            if (objetoJson.status === true) {
              const dados = objetoJson.dados;
              console.log(dados);
              adicionarDadosATabela(dados);
            } else {
              console.log("deu ruim");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
    
        // Manipulador de evento para o botão "btnExportarCsv"
        const btnExportarCsv = document.getElementById("btnExportarCsv");
        if (btnExportarCsv) {
          btnExportarCsv.addEventListener("click", function () {
            exportarParaCSV();
          });
        } else {
          console.error("O botão com id 'btnExportarCsv' não foi encontrado.");
        }
    
        // Função para exportar dados para CSV
        function exportarParaCSV() {
          const dadosTabela = document.getElementById("tableBody");
          const linhas = dadosTabela.querySelectorAll("tr");
    
          // Cria um array para armazenar linhas CSV
          const linhasCSV = [];
    
          // Loop através das linhas da tabela
          linhas.forEach(function (linha) {
            const colunas = linha.querySelectorAll("td");
            const valores = [];
    
            // Loop através das colunas da linha
            colunas.forEach(function (coluna) {
              valores.push(coluna.textContent);
            });
    
            // Adiciona a linha CSV ao array
            linhasCSV.push(valores.join(","));
          });
    
          // Cria um blob CSV
          const csvContent = "data:text/csv;charset=utf-8," + linhasCSV.join("\n");
          const encodedUri = encodeURI(csvContent);
    
          // Cria um elemento de link para download e simula um clique
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "dados.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
    
        // Função para adicionar dados à tabela
        function adicionarDadosATabela(dados) {
          // Obtenha a referência do tbody
          const tableBody = document.getElementById("tableBody");
    
          dados.forEach((nota) => {
            // Crie uma nova linha na tabela
            const row = tableBody.insertRow();
    
            // Adicione as células com os dados
            const cellIdNota = row.insertCell(0);
            cellIdNota.textContent = nota.idNota;
    
            const cellNomeDisciplina = row.insertCell(1);
            cellNomeDisciplina.textContent = nota.nome_turma;
    
            const cellIdDisciplina = row.insertCell(2);
            cellIdDisciplina.textContent = nota.Disciplina_idDisciplina;
    
            const cellNomeAluno = row.insertCell(3);
            cellNomeAluno.textContent = nota.nome_disciplina;
    
            const cellAlunoMatricula = row.insertCell(4);
            cellAlunoMatricula.textContent = nota.Aluno_matricula;
    
            const cellNomeALuno = row.insertCell(5);
            cellNomeALuno.textContent = nota.nome_aluno;
    
            const cellBimestre = row.insertCell(6);
            cellBimestre.textContent = nota.bimestre;
    
            const cellNota = row.insertCell(7);
            cellNota.textContent = nota.nota;
    
            const cellUltimaAlteracao = row.insertCell(8);
            cellUltimaAlteracao.textContent = nota.ultimaAlteracao;
    
            const cellTipoNota = row.insertCell(9);
            cellTipoNota.textContent = nota.tipoNota;
    
            const cellFezLista = row.insertCell(10);
            cellFezLista.textContent = nota.fezLista;
    
            // Adicione a célula de seleção (pode ser um botão, checkbox, etc.)
            const cellSelecionar = row.insertCell(11);
            var btnDetalhes = document.createElement("button");
            btnDetalhes.textContent = "Detalhes";
            btnDetalhes.classList.add("btn", "btn-info");
            btnDetalhes.addEventListener("click", function () {
              handleDetalhesButtonClick_DetalhesAluno(nota);
            });
            cellSelecionar.appendChild(btnDetalhes);
          });
    
          // Função para lidar com o clique do botão Detalhes
          function handleDetalhesButtonClick_DetalhesAluno(nota) {
            console.log("Detalhes da array nota:", nota);
    
            // Preenche os campos de entrada com os valores da linha clicada
            document.getElementById("txtAlunoMatricula_Detalhes").value = nota.Aluno_matricula;
            document.getElementById("txtNomeAluno_Detalhes").value = nota.nome_aluno;
            document.getElementById("txtBimestre_Detalhes").value = nota.bimestre;
          }
        }
      };

      // Função para extrair os dados da tabela e calcular a média das notas por bimestre
      function calcularMediaNotasPorBimestre(dados) {
        const mediasPorBimestre = {};

        dados.forEach((nota) => {
          const bimestre = nota.bimestre;
          const notaValue = parseFloat(nota.nota);

          if (!mediasPorBimestre[bimestre]) {
            mediasPorBimestre[bimestre] = { total: 0, count: 0 };
          }

          mediasPorBimestre[bimestre].total += notaValue;
          mediasPorBimestre[bimestre].count += 1;
        });

        // Calcula a média para cada bimestre
        const medias = Object.keys(mediasPorBimestre).map((bimestre) => {
          const media =
            mediasPorBimestre[bimestre].total / mediasPorBimestre[bimestre].count;
          return { bimestre, media };
        });

        return medias;
      }

      // Função para renderizar o gráfico usando Chart.js
      function renderizarGrafico(medias) {
        const labels = medias.map((media) => media.bimestre);
        const data = medias.map((media) => media.media);

        var ctx = document.getElementById("chartContainer").getContext("2d");
        var myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Média das Notas por Bimestre",
                data: data,
                backgroundColor: "rgba(0, 0, 255, 0.5)",
                borderColor: "rgba(0, 0, 255, 0.5)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Manipulador de evento para o botão "btnExportargrafico"
      const btnExportargrafico = document.getElementById("btnExportargrafico");
      if (btnExportargrafico) {
        btnExportargrafico.addEventListener("click", function () {
          const dadosTabela = document.getElementById("tableBody");
          const linhas = dadosTabela.querySelectorAll("tr");

          const dados = [];
          linhas.forEach(function (linha) {
            const colunas = linha.querySelectorAll("td");
            const nota = parseFloat(colunas[7].textContent); // Coluna da nota
            const bimestre = colunas[6].textContent; // Coluna do bimestre

            dados.push({ nota, bimestre });
          });

          const medias = calcularMediaNotasPorBimestre(dados);
          renderizarGrafico(medias);
        });
      } else {
        console.error("O botão com id 'btnExportargrafico' não foi encontrado.");
      }
    </script>
  </body>
</html>
